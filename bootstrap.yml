---
- hosts: windows
  gather_facts: no
  tasks:
    - name: Download and run ConfigureRemotingForAnsible.ps1 to setup WinRM
      psexec:
        hostname: "{{ansible_host}}"
        connection_username: hccadmin
        connection_password: ServiceP@ss123!
        encrypt: no
        integrity_level: elevated
        process_username: hccadmin
        process_password: ServiceP@ss123!
        executable: powershell.exe
        arguments: '-'
        stdin: |
            $ErrorActionPreference = "Stop"
            $url = "https://raw.githubusercontent.com/jborean93/ansible-windows/master/scripts/Upgrade-PowerShell.ps1"
            $file = "$env:SystemDrive\temp\Upgrade-PowerShell.ps1"
            $username = "hccadmin"
            $password = "ServiceP@ss123!"
            (New-Object -TypeName System.Net.WebClient).DownloadFile($url, $file)
            Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Force
            &$file -Version 5.1 -Username $username -Password $password -Verbose
            exit
      delegate_to: localhost
      