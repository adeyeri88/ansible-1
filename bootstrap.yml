---
- hosts: windows
  gather_facts: no
  tasks:
    - name: Download and run ConfigureRemotingForAnsible.ps1 to setup WinRM
      psexec:
        hostname: "{{ansible_host}}"
        connection_username: hccadmin
        connection_password: ServiceP@ss123!
        encrypt: no
        executable: powershell.exe
        arguments: -username hccadmin -password ServiceP@ss123! -Verbose
        stdin: |
            $ErrorActionPreference = "Stop"
            $url = "https://raw.githubusercontent.com/jborean93/ansible-windows/master/scripts/Upgrade-PowerShell.ps1"
            Invoke-Expression ((New-Object Net.WebClient).DownloadString($url))
            exit
      delegate_to: localhost
      