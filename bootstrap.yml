---
- hosts: windows
  gather_facts: no
  tasks:
    - name: Disable encryption to work with Windows Server 2008 (R2)
      psexec:
        hostname: "{{ansible_host}}"
        encrypt: no
        connection_username: '{{ansible_user}}'
        connection_password: '{{ansible_password}}'
        integrity_level: elevated
        process_username: '{{ansible_user}}'
        process_password: '{{ansible_password}}'
        executable: powershell.exe
        arguments: (New-Object -ComObject Microsoft.Update.Session).CreateUpdateInstaller().IsBusy
      delegate_to: localhost