---
- hosts: windows
  gather_facts: no
  tasks:
    - name: Download and run ConfigureRemotingForAnsible.ps1 to setup WinRM
      psexec:
        hostname: "{{ansible_host}}"
        connection_username: hccadmin
        connection_password: ServiceP@ss123!
        encrypt: no
        executable: powershell.exe
        arguments: '-version 3.0 -username "hccadmin" -password "ServiceP@ss123!" -Verbose'
        stdin: |
            $ErrorActionPreference = "Stop"
            $sec_protocols = [Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::SystemDefault
            $sec_protocols = $sec_protocols -bor [Net.SecurityProtocolType]::Tls12
            [Net.ServicePointManager]::SecurityProtocol = $sec_protocols
            $url = "https://github.com/jborean93/ansible-windows/blob/master/scripts/Upgrade-PowerShell.ps1"
            Invoke-Expression ((New-Object Net.WebClient).DownloadString($url))
            exit
      register: psexec_process_system